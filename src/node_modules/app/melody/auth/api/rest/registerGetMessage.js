import createDebugger       from 'evoke-me/debug/api/create'

import config               from '../config'
import errorMap             from '../../../manager/api/errorMap'


const who = [config.namespace, config.entity, `api`, `rest`, `registerGetMessage`]
const debug = createDebugger(who.join(`:`))

export default async (payload, options = {}) => {
  try {
    debug(payload, options)
    const {
      clientType = `M`,
      mobileNo,
      pictureCode,
      sendType = 1,
    } = payload
    const {
      host = `https://api.melodycity.cn/v1`
    } = options

    const response = await fetch(`${host}/mobile/getMobileCode?mobileNo=${mobileNo}&clientType=${clientType}&sendType=${sendType}&pictureCode=${pictureCode}`)
    const json = await response.json()

    const { code, message } = json

    if (code === 0) {
      return {
        result: true,
        errors: [],
      }
    }

    return {
      result: null,
      errors: [{
        type: config.namespace,
        code: errorMap.ERROR_CODE_NOT_ZERO,
        message,
      }],
    }
  } catch (err) {
    debug(`ERROR`, err)

    return {
      result: null,
      errors: [{
        type: config.namespace,
        code: errorMap.UNKNOWN,
        message: `Unknown error`,
      }]
    }
  }
}
