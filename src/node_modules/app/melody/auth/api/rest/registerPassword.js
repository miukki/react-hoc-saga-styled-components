import createDebugger       from 'evoke-me/debug/api/create'

import config               from '../config'
import errorMap             from '../../../manager/api/errorMap'


const who = [config.namespace, config.entity, `api`, `rest`, `registerPassword`]
const debug = createDebugger(who.join(`:`))

export default async (payload, options = {}) => {
  try {
    debug(payload, options)
    const {
      mobileCode,
      mobileNo,
      password,
      readAndAgree,
    } = payload
    const {
      host = `https://api.melodycity.cn/v1`
    } = options

    const response = await fetch(`${host}/user/register?mobileNo=${mobileNo}&mobileCode=${mobileCode}&password=${password}&readAndAgree=${readAndAgree}`)
    const json = await response.json()

    const { code, message, data: { sessionKey }} = json

    if (code === 0) {
      return {
        result: {
          message,
          sessionKey,
        },
        errors: [],
      }
    }

    return {
      result: null,
      errors: [{
        type: config.namespace,
        code: errorMap.ERROR_CODE_NOT_ZERO,
        message,
        props: {
          code,
        }
      }],
    }
  } catch (err) {
    debug(`ERROR`, err)

    return {
      result: null,
      errors: [{
        type: config.namespace,
        code: errorMap.UNKNOWN,
        message: `Unknown error`,
      }]
    }
  }
}
