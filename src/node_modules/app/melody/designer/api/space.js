import spaceDefaults        from 'evoke-me/space/api/spaceDefaults'

import config               from './config'
import queryByRole          from './rest/client/queryByRole'


export default [
  config.namespace,
  config.entity,
  [],
  () => ({
    ...spaceDefaults.state,
  }),
  {
    ...spaceDefaults.updaters,

    queryByRole: (setState, getState, { create, orderClear }) => function* (payload) {
      try {
        yield setState({ isLoading: true })

        const {
          roleId = `600007`,
        } = payload

        const { result, errors } = yield queryByRole(payload)

        if (errors.length) {
          return yield setState({ errors, isLoading: false })
        }

        const orderName = `byRole_${roleId}`
        yield orderClear(orderName)
        for (let doc of result) {
          yield create(doc, { orderName })
        }

        yield setState({ isLoading: false })
      } catch (err) {
        yield setState({ isLoading: false })

        console.error(err)
      }
    },
  }
]
